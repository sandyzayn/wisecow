name: CI/CD for WiseCow App

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Log in to GitHub Container Registry
      run: echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Build Docker image
      run: |
        docker build -t ghcr.io/sandyzayn/wisecow-app:${{ github.sha }} .

    - name: Test the application
      run: |
        docker run --rm ghcr.io/sandyzayn/wisecow-app:${{ github.sha }} which cowsay
        docker run --rm ghcr.io/sandyzayn/wisecow-app:${{ github.sha }} which fortune

    - name: Push Docker image
      run: |
        docker push ghcr.io/sandyzayn/wisecow-app:${{ github.sha }}
        
    - name: Success message
      run: |
        echo "‚úÖ CI/CD Pipeline Completed Successfully!"
        echo "üì¶ Docker Image: ghcr.io/sandyzayn/wisecow-app:${{ github.sha }}"
        echo "üê≥ Run locally: docker run -p 3000:3000 ghcr.io/sandyzayn/wisecow-app:${{ github.sha }}"
        echo "üîó Image URL: https://ghcr.io/sandyzayn/wisecow-app:${{ github.sha }}"
