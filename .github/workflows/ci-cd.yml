name: CI/CD for WiseCow App

on:
  push:
    branches: [ main ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      run: echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Build Docker image
      run: |
        docker build -t ghcr.io/sandyzayn/wisecow-app:${{ github.sha }} .

    - name: Test application
      run: |
        echo "ðŸ§ª Testing application..."
        docker run --rm ghcr.io/sandyzayn/wisecow-app:${{ github.sha }} node -e "console.log('âœ… Application can start successfully')"

    - name: Push Docker image
      run: |
        docker push ghcr.io/sandyzayn/wisecow-app:${{ github.sha }}
        
    - name: Success message
      run: |
        echo "âœ… Build and push completed successfully!"
        echo "ðŸ“¦ Image: ghcr.io/sandyzayn/wisecow-app:${{ github.sha }}"
        echo "ðŸ”— You can pull and run locally:"
        echo "   docker run -p 3000:3000 ghcr.io/sandyzayn/wisecow-app:${{ github.sha }}"
